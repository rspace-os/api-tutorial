# api-tutorial

## Introduction

This project provides an introduction to using the RSpace API.

### Who is this tutorial for?

For software developers, or scientists with programming or scripting skills, to learn how to use the
RSpace API to interact programmatically with the RSpace Electronic Lab Notebook.

### How does this tutorial fit in with other RSpace API documentation?

* The [RSpace help documentation](http://www.researchspace.com/help-and-support-resources/rspace-api-introduction/)
  describes how to get your API token from the RSpace UI.
* The [API technical reference](https://community.researchspace.com/public/apiDocs)
  describes low-level technical details of the API endpoints
  and API contracts.
* [Example code projects](https://github.com/rspace-os) provide language-specific API client example code. 

### What version of RSpace is required for this tutorial?

RSpace 1.45 or newer is needed to follow the steps.

### Use-cases for the API
In the first part of the tutorial, we'll consider some simple use cases such as:

 * Uploading files from instruments or your device into RSpace automatically.
 * Creating RSpace documents and linking to files.
 * Adding or editing content in an RSpace document.
 * Searching and retreiving files and documents

In the second part, we'll combine these operations together to form a more complex workflow,
illustrating the potential of the API.

### Getting started
* Follow the instructions in the [RSpace help documentation](http://www.researchspace.com/help-and-support-resources/rspace-api-introduction/)
  to get set up with an API key for your account.
* This tutorial will use `curl` commands to make API calls rather than assume a particular programming language.

Code examples are shown in the following syntax:

    curl -v -H "accept: application/json" -H "apiKey:<APIKEY>"  "<RSPACE_URL>/api/v1/files"
    
 * The `-v` option to curl shows verbose information about the request to help you debug any problems
 * You generally need to supply the content type to be accepted, and your API key, as request headers. Replace '<APIKEY'>
   with your own key.
 * Replace <RSPACE_URL> with the base URL of your RSpace installation. E.g. if you're using RSpace Community, this 
   would be `https://community.researchspace.com` 
   
All code snippets are provided as working examples in the `tutorial-data` folders in this project.
 

## Creating content

### Uploading files

Being able to upload a file to RSpace automatically can save you a lot of time and effort compared to manually
using the web application. You can perform tasks such as

 * Bulk upload of files
 * Scheduled upload of files, e.g. files generated by an instrument, sequence  files, image files etc

The simplest way to upload a file is as follows:

    curl -v  -X POST -H "accept: application/json" -H "apiKey: <APIKEY>" \
    -H "content-type: multipart/form-data" -F "file=@<MY_FILE.txt>" \
     "<RSPACE_URL>/api/v1/files"
     
This will upload a file '<MY_FILE.txt>'  a  default folder called 'Api Inbox' in the relevant section
 of the Gallery. This folder will be automatically created for you if it doesn't yet exist. JSON will be returned:

    {
      "id" : 728,
      "globalId" : "GL728",
      "name" : "<MY_FILE.txt>",
      "caption" : "",
      "contentType" : "text/plain",
      "created" : "2017-07-23T09:54:16.007Z",
      "size" : 2812,
      "_links" : [ {
         "link" : "<RSPACE_URL>/api/v1/files/728",
         "rel" : "self"
       }, {
         "link" : "<RSPACE_URL>/api/v1/files/728/file",
         "rel" : "enclosure"
      } ]
    }
    
 The `_links` property contains pre-generated links to resources created or referenced in API calls. In this case, the 'self'
  link will return the file metadata, and the 'enclosure' link will download the file contents. These will be described later.
    
 You can also upload a file with an optional caption, and also specify a folder to put the file in.
 
     curl -v  -X POST -H "accept: application/json" -H "apiKey: <APIKEY>" \
     -H "content-type: multipart/form-data" -F "file=@<MY_FILE.txt>" -F"folderId=<FOLDER_ID>\
     -F "caption=some metadata about this file" \"<RSPACE_URL>/api/v1/files"
     
 The caption will appear in the 'Info' section of each Gallery item, and just like a manually edited caption, will be searchable.
 This is a good way to add some descriptive metadata to your file so that you can locate it easily.
 
 As of 1.45, browsing folders via the API is not yet supported. However it's very easy to get a folder ID from RSpace by clicking
  on the 'info' icon beside a Gallery folder.
 
 **Note:** There are some restrictions on which folders you can upload to. For example, if uploading image files, a folder ID must
  be either the Gallery Images folder, or a subfolder of the images folder. You can't upload a file directly into a workspace folder
   or notebook.
   
 If you're uploading many files of mixed type, then it's probably safer not to specify a single folder, but to let them be 
 placed in the relevant `API Inbox` folder where you can organise them later.
 
 #### Uploading files from a folder.
 
 The script [batchUpload.sh](tutorial-data/uploading-a-file-1/batchUpload.sh) will upload files sequentially from a list
 on the command line, e.g.
 
     # upload a single file
     ./batchUpload.sh myFile.txt
     # upload all png files in folder
     ./batchUpload.sh `ls *.png`
     
### Downloading files

You can download files from RSpace to your device using the following syntax:

    curl -v  -H "accept:application/octet-stream" -H "apiKey:<APIKEY>" "<RSPACE_URL>/api/v1/files/<FILE_ID>/file"
 
### Creating documents

You can create documents of different types, and add content to some or all of the fields.
Some of the examples use JSON request bodies - files of JSON data are in  [this project](tutorial-data/creatingDocument).

#### Creating a basic document.

This is the simplest way to create a document - it will be a 'Basic Document' (a single text field) with default name 'Untitled Document' and
 no content. Note that an empty request body '-d {}' is required.
 
    curl -X POST -H "content-type: application/json" -H "apiKey:<APIKEY>" -d {} "<RSPACE_URL>/api/v1/documents"
    
This example is a little more useful - creating a named, tagged Basic Document with some content:

    curl -X POST -H "content-type: application/json" -H "apiKey:<APIKEY>" \
       -d "@tutorial-data/creatingDocument/basicDocument-named-withContent.json \
       "<RSPACE_URL>/api/v1/documents"
       
#### Creating links in documents to files

If you want to create links to files in a document's content, you can easily do this by adding a tag with the syntax:

    <fileId=1234>
    
  to your document content, e.g. replacing '1234' with the id of your file. RSpace will then create links in exactly the same way
  as it does in the UI. E.g.
    
    {
      "name": "My Experiment",
      "tags": "API,example",
      "fields": [
         {
           "content": "Protocol as described in <fileId=1234>, except using EDTA 3uM. "
         }
        ]
    }

#### Editing existing content in a basic document

You can alter the content of an existing document using a `PUT` request to the `/documents/{docId}` endpoint. The new
content will replace existing content. If someone else is editing the document, then the request will fail,
returning a `409 Conflict` error code.  

You just include in the request body the data that you want to change - any/all of name, tags and field content.

    curl -v  -X PUT -H "content-type: application/json" -H "apiKey: <APIKEY>"\
      -d "@/tutorial-data/editingDocument/editBasicDocument.json"  "<RSPACE_URL>/api/v1/documents/<DOC_ID>"
      
#### Creating and editing multi-field documents.

Now we know how to  create simple documents, let's consider multi-field of 'Structured Documents' that contain 
 fields of different types as defined by a Form. You can add/edit content to any or all of the fields.
 
In this section we'll be using the standard 'Experiment' form that is already defined for you in RSpace. It contains
 7 text fields: Method, Objective, Procedure, Results, Discussion, Conclusion, Comment.
 
 You'll need to get the ID of the form from the UI, and include this ID as in the  'form' property in the request body.
 When adding content, the order is important. If for example, you just want to add content to the 'Procedure' field,
  which is the 3rd field, then supply a list of 7 fields, of which only the 3rd has some data, e.g.
  
    curl -X POST -H "content-type: application/json" -H "apiKey:<APIKEY>" \
      -d "@/tutorial-data/creatingDocument/complexDocument-named-withContent.json" "<RSPACE_URL>/api/v1/documents"
 
 When editing content, there are two options. Either you can send the data as a list of all fields, as for POST, including content
  as necessary, or you can reference a field by its ID, and just send values for those specific fields.
  
    curl -v  -X PUT -H "content-type: application/json" -H "apiKey: <APIKEY>"\
      -d "@/tutorial-data/editingDocument/editComplexDocument-named-withFieldIds.json"  "<RSPACE_URL>/api/v1/documents/<DOC_ID>"
      
 As for BasicDocuments, you can also send edit name and tags in the request body as well.
  
